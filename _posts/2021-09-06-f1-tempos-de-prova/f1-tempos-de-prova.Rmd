---
title: "F1 Tempos de Prova"
description: |
  A short description of the post.
author:
  - first_name: Nicholas 
    last_name: Marino
    url: https://github.com/nacmarino
date: 09-06-2021
categories:
  - tidytuesday
  - tidymodels
output:
  distill::distill_article:
    self_contained: false
    toc: true
    code_folding: true
    highlight: rstudio
draft: true
---

```{r setup, include=FALSE}
# setando as opções gerais dos code chunks
knitr::opts_chunk$set(echo = FALSE, code_folding = FALSE, fig.align = 'center')

# presetando o ggplot2
library(ggplot2)

# setando o tema geral do ggplot2
theme_set(new = theme_minimal(base_family = 'Roboto'))

# atualizando o tema
theme_update(
  plot.title    = element_text(face = 'bold', size = 10),
  plot.subtitle = element_text(size = 8),
  plot.caption  = element_text(size = 8),
  axis.title    = element_text(face = 'bold', size = 8),
  axis.text     = element_text(color = 'black', size = 8),
  strip.text    = element_text(face = 'bold', size = 8)
)
```

# Motivação

# Preparação dos Dados

## Carregando os Dados

blablabla

```{r carrega_dados}
# carregando os pacotes necessários
library(tidyverse) # core
# library(tidytuesdayR) # ler os arquivos do tidytuesday
library(fs) # manipular paths
library(lubridate) # trablhar com datas
library(ggforce) # extender o ggplot2

# carregando todos os dados a partir do github do tidytuesday
# tt_dataset <- tt_load(x = 2021, week = 37) # se você quiser baixar os dados direto da fonte

# carregando a copia local dos dados
## extraindo os paths das copias locais
paths_copias_locais <- dir_ls(path = 'data/')
# paths_copias_locais <- dir_ls(path = '_posts/2021-09-06-f1-tempos-de-prova/data/')

## criando vetor de nomes dos arquivos
nomes_arquivos <- paths_copias_locais %>% 
  path_file() %>% 
  path_ext_remove()

## carregando os arquivos em uma lista
tt_dataset <- map(.x = paths_copias_locais, .f = read_rds)

## renomeando os elementos da lista
names(tt_dataset) <- nomes_arquivos
```

## Variável Resposta 

blablabla

```{r junta_status_dict}
## adicionando o dicionario com o de-para do statusId
resultados <- left_join(x = tt_dataset$results,
                        y = tt_dataset$status,
                        by = 'statusId')
resultados
```

```{r cria_base_target}
# criando base com o minimo, media e maximo dos tempos de cada prova
tempos_de_prova <- resultados %>% 
  # pegando apenas os pilotos que concluiram a prova
  filter(status == 'Finished') %>% 
  # removendo qualquer valor na coluna milliseconds que não contenha pelo menos um número
  filter(str_detect(string = milliseconds, pattern = '[0-9]')) %>% 
  # parseando a coluna de milliseconds para numerico
  mutate(
    milliseconds = parse_number(milliseconds)
  ) %>% 
  # agrupando pela prova
  group_by(raceId) %>% 
  # pegando o valor minimo, medio e maximo dos tempo de prova
  summarise(
    minimo = min(milliseconds),
    media  = mean(milliseconds),
    maximo = max(milliseconds)
  ) %>% 
  # passando millisegundos para minutos
  mutate(
    across(.cols = minimo:maximo, \(x) (x / 1000) / 60)
  ) %>% 
  pivot_longer(cols = minimo:maximo, names_to = 'metrica', values_to = 'duracao')
tempos_de_prova
```

## Feature Engineering

blablabla

```{r participantes_por_prova}
participantes_por_prova <- resultados %>% 
  # pegando os valores unicos das chaves primarias por prova
  distinct(raceId, driverId, constructorId) %>% 
  # agrupando por prova
  group_by(raceId) %>% 
  # quantidade de pilotos e construtores por prova
  summarise(
    n_pilotos      = n_distinct(driverId),
    n_construtores = n_distinct(constructorId)
  )
participantes_por_prova
```

blablabla

```{r voltas_por_prova}
## calculando a quantidade de voltas em cada prova
voltas_por_prova <- resultados %>% 
  # considerando apenas os pilotos que concluiram cada prova
  filter(status == 'Finished') %>% 
  # selecionando as colunas de interesse
  select(raceId, laps) %>% 
  # pegando o valor maximo da quantidade de voltas por prova
  group_by(raceId) %>% 
  summarise(laps = max(laps))
voltas_por_prova
```

blablabla

```{r velocidade_por_prova}
## calculando a velocidade maxima registrada em cada prova
velocidade_por_prova <- resultados %>% 
  # parseando a coluna para numerico
  mutate(
    fastestLapSpeed = parse_number(fastestLapSpeed)
  ) %>% 
  # calculando a velocidade maxima registrada em cada prova
  group_by(raceId) %>% 
  summarise(top_speed = max(fastestLapSpeed, na.rm = TRUE))
velocidade_por_prova
```

blablabla

```{r infos_das_provas}
## mapeando cada circuito à uma prova
provas <- left_join(x = tt_dataset$races,
                    y = tt_dataset$circuits,
                    by = 'circuitId') %>% 
  # removendo URL da wikipedia
  select(-contains('url'), -circuitRef, -circuitId, -round) %>%
  # renomeando o nome do GP e do circuito
  rename(gp = name.x, circuit = name.y) %>% 
  # levantando informacoes de data
  mutate(
    data = paste(date, time),
    data = as_datetime(data),
    mes = month(data),
    semana = isoweek(x = data),
    turno_pm = pm(data)
  ) %>% 
  select(-date, -time)
provas
```

## Base Analítica

blablabla

```{r junta_features_por_prova}
## juntando informacoes das provas com a quantidade de participantes e construtores
features_por_prova <- left_join(x = provas,
                                y = participantes_por_prova,
                                by = 'raceId') %>% 
  ## juntando de voltas por prova
  left_join(y = voltas_por_prova,
            by = 'raceId') %>% 
  # juntando velocidade maxima registrada em cada prova
  left_join(y = velocidade_por_prova,
            by = 'raceId')
features_por_prova
```

blablabla

```{r cria_base_analitica}
df <- left_join(x = tempos_de_prova, y = features_por_prova, by = 'raceId')
df
```

# Análise Exploratória

Como é a série histórica.

```{r serie_temporal, layout = 'l-body-outset', fig.height=4, dpi = 300}
df %>% 
  mutate(
    data = as_date(data),
    decada = (year %/% 10) * 10,
    decada = as.character(decada)) %>% 
  filter(metrica == 'media') %>% 
  ggplot(mapping = aes(x = data, y = duracao)) +
  geom_line(alpha = 0.3, size = 1) +
  geom_point(mapping = aes(fill = decada), 
             shape = 21, size = 1.5, alpha = 0.3, color = 'black', show.legend = FALSE) +
  geom_smooth(se = FALSE, color = 'firebrick3') +
  scale_x_date(breaks = seq.Date(from = as.Date('1950-01-01'), to = as.Date('2021-12-01'), by = '5 years'),
               labels = seq(from = 1950, to = 2020, by = 5)) +
  scale_fill_viridis_d() +
  labs(
    title    = 'Série histórica da duração das provas',
    subtitle = 'A linha vermelha representa a tendência geral de duração das provas no histórico, enquanto os pontos representam\na duração de cada uma das provas ocorridas',
    x        = 'Período',
    y        = 'Duração Média (minutos)'
  ) +
  theme(legend.position = 'none')
```

Quais GPs ocorreram em quais períodos. Prepara o dado.

```{r monta_historico_gp_ano}
historico_gps_ano <- df %>% 
  distinct(gp, data) %>% 
  mutate(ano = year(data)) %>% 
  arrange(gp, ano) %>% 
  group_by(gp) %>%
  mutate(
    recorrencia = (ano - lag(ano)) != 1 | is.na(ano - lag(ano)),
    grupo_recorrencia = cumsum(recorrencia),
    n_gps = n()
  )
filter(historico_gps_ano, gp == 'Argentine Grand Prix')
```

Mostra o dado.

```{r historico_gp_ano, layout = 'l-body-outset', fig.height=10, dpi = 300}
historico_gps_ano %>% 
  group_by(gp, grupo_recorrencia) %>% 
  summarise(
    inicio  = min(ano),
    fim     = max(ano),
    n_gps   = max(n_gps),
    .groups = 'drop'
  ) %>% 
  mutate(
    gp = fct_reorder(.f = gp, .x = n_gps, .fun = max)
  ) %>% 
  ggplot() +
  geom_segment(mapping = aes(x = inicio, xend = fim, y = gp, yend = gp)) +
  geom_point(mapping = aes(x = inicio, y = gp), size = 3,
             shape = 21, color = 'black', fill = 'white') +
  geom_point(mapping = aes(x = fim, y = gp), size = 3,
             shape = 21, color = 'black', fill = 'grey40') +
  scale_x_continuous(breaks = seq(from = 1950, to = 2020, by = 5)) +
  labs(
    title    = 'Ocorrência de cada Gran Prix ao longo dos anos',
    subtitle = 'Os segmentos sinalizam o intervalo de anos seguidos nos quais cada GP ocorreu',
    x        = 'Período'
  ) +
  theme(axis.title.y = element_blank())
```

Ocorrência dos GPs varia entre meses no histórico também.

```{r historico_gp_mes, layout = 'l-body-outset', fig.height=10, dpi = 300, code_folding = TRUE}
df %>% 
  distinct(gp, data) %>% 
  mutate(mes = month(data)) %>%  
  count(gp, mes, name = 'observacoes') %>% 
  group_by(gp) %>% 
  mutate(
    total   = sum(observacoes),
    obs_std = observacoes / total
  ) %>% 
  ungroup %>% 
  mutate(
    gp = fct_reorder(.f = gp, .x = mes, .fun = min),
    gp = fct_rev(f = gp)
  ) %>% 
  complete(gp, mes) %>% 
  ggplot(mapping = aes(x = mes, y = gp, fill = obs_std)) +
  geom_tile(color = 'black') +
  geom_text(mapping = aes(label = observacoes, color = obs_std)) +
  scale_fill_viridis_c(na.value = 'white') +
  scale_color_viridis_c(option = 'A', direction = -1, na.value = 'white') +
  scale_x_continuous(breaks = seq(from = 1, to = 12, by = 1),
                     labels = month(x = 1:12, label = TRUE, abbr = TRUE, locale = 'pt_BR'),
                     expand = c(0, 0)) +
  labs(
    title = 'Distribuição histórica da ocorrências dos GPs entre meses',
    x     = 'Período'
  ) +
  theme(
    legend.position = 'none',
    axis.title.y = element_blank()
  )
```

Ocorrencias por circuito.

```{r ocorrencias_por_circuito, layout = 'l-page', fig.height=10, fig.width=10, dpi = 300}
df %>% 
  distinct(gp, circuit, year) %>% 
  count(gp, circuit, name = 'ocorrencias') %>% 
  mutate(
    n_unico = 1
  ) %>% 
  mutate(
    gp      = fct_reorder(.f = gp, .x = n_unico, .fun = sum),
    circuit = fct_reorder(.f = circuit, .x = ocorrencias, .fun = sum)) %>% 
  ggplot(mapping = aes(x = n_unico, y = gp, group = circuit)) +
  geom_col(fill = 'grey30', color = 'white') +
  geom_text(mapping = aes(label = paste0(abbreviate(circuit), ': ', ocorrencias)), 
            color = 'white', size = 3,
            position = position_stack(vjust = 0.5)) +
  theme(legend.position = 'none')
```

GP da Grã-Bretanha.

```{r serie_temporal_british, layout = 'l-body-outset', fig.height=4, dpi = 300}
df %>% 
  mutate(
    data = as_date(data)
  ) %>% 
  filter(metrica == 'media', gp %in% c('British Grand Prix', 'Italian Grand Prix')) %>% 
  ggplot(mapping = aes(x = data, y = duracao, color = gp)) +
  facet_wrap(~ gp, scales = 'free', nrow = 2) +
  geom_line(size = 1) +
  geom_point(shape = 21, size = 1.5, color = 'black', fill = 'white') +
  scale_x_date(breaks = seq.Date(from = as.Date('1950-01-01'), to = as.Date('2021-12-01'), by = '5 years'),
               labels = seq(from = 1950, to = 2020, by = 5)) +
  labs(
    title    = 'Série histórica da duração dos GPs da Inglaterra e Itália',
    subtitle = 'Estas são as duas provas com a série histórica de ocorrências mais consistente',
    x        = 'Período',
    y        = 'Duração Média (minutos)'
  ) +
  theme(legend.position = 'none')
```

# Análise dos Dados

# Conclusão